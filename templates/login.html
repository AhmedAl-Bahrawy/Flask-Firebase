{% extends "base.html" %} {% block title %}Login{% endblock %} {% block
body_class %}login{% endblock %} {% block flash_class %}inline{% endblock %} {%
block flash_item_class %}inline{% endblock %} {% block content %}
<div class="container">
  <h2>Welcome Back</h2>

  {% block flash_messages %} {% with messages =
  get_flashed_messages(with_categories=true) %} {% if messages %}
  <div class="flash-messages inline">
    {% for category, message in messages %}
    <div class="flash {{ category }} inline">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %} {% endwith %} {% endblock %}

  <form method="post" id="loginForm">
    <div class="form-group">
      <input
        type="email"
        id="email"
        name="email"
        required
        autocomplete="email"
        placeholder="Email address"
      />
      <label for="email" class="floating-label">Email address</label>
    </div>
    <div class="form-group">
      <input
        type="password"
        id="password"
        name="password"
        required
        autocomplete="current-password"
        placeholder="Password"
      />
      <label for="password" class="floating-label">Password</label>
    </div>
    <div class="remember-me">
      <input type="checkbox" id="remember" name="remember" />
      <label for="remember">Remember me</label>
    </div>
    <button type="submit">Sign In</button>
  </form>

  <div class="divider">
    <span>or</span>
  </div>

  <button type="button" class="google-btn" id="googleSignInBtn">
    <div class="google-icon"></div>
    Continue with Google
  </button>

  <div class="footer">
    <p>
      Don't have an account? <a href="{{ url_for('register') }}">Sign up</a>
    </p>
    <p><a href="{{ url_for('forgot_password') }}">Forgot password?</a></p>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script>
  // Firebase configuration - Replace with your config
  const firebaseConfig = {
    apiKey: "AIzaSyADDXhfQxgj76lNDq2W9-BqlC3XYTOXWp8",
    authDomain: "flask-auth-c8ce2.firebaseapp.com",
    projectId: "flask-auth-c8ce2",
    storageBucket: "flask-auth-c8ce2.firebasestorage.app",
    messagingSenderId: "50459132624",
    appId: "1:50459132624:web:a8ff2c906c78d814a314d5",
    measurementId: "G-K3MJFW9LHF",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // Initialize Firebase Auth provider
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.addScope("email");
  provider.addScope("profile");

  // Google Sign-In
  document
    .getElementById("googleSignInBtn")
    .addEventListener("click", async function () {
      const btn = this;
      btn.classList.add("loading");
      btn.textContent = "Signing in...";

      try {
        const result = await firebase.auth().signInWithPopup(provider);
        const user = result.user;
        const idToken = await user.getIdToken();

        // Send token to backend
        const response = await fetch("/google-auth", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            idToken: idToken,
          }),
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = data.redirect;
        } else {
          throw new Error(data.error || "Google sign-in failed");
        }
      } catch (error) {
        console.error("Google sign-in error:", error);

        // Create and show error message
        const flashContainer =
          document.querySelector(".flash-messages") ||
          document.createElement("div");
        flashContainer.className = "flash-messages inline";

        const flashDiv = document.createElement("div");
        flashDiv.className = "flash error inline";
        flashDiv.textContent =
          error.message || "Google sign-in failed. Please try again.";

        flashContainer.innerHTML = "";
        flashContainer.appendChild(flashDiv);

        if (!document.querySelector(".flash-messages")) {
          document.querySelector("h2").after(flashContainer);
        }
      } finally {
        btn.classList.remove("loading");
        btn.innerHTML = '<div class="google-icon"></div>Continue with Google';
      }
    });

  // Regular form submission
  document.getElementById("loginForm").addEventListener("submit", function (e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.classList.add("loading");
    submitBtn.textContent = "Signing in...";
  });
</script>
{% endblock %}
